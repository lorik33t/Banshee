"use strict";var xo=Object.create;var ie=Object.defineProperty;var Co=Object.getOwnPropertyDescriptor;var Ro=Object.getOwnPropertyNames;var Po=Object.getPrototypeOf,Eo=Object.prototype.hasOwnProperty;var P=(n,e)=>()=>(n&&(e=n(n=0)),e);var Ve=(n,e)=>{for(var t in e)ie(n,t,{get:e[t],enumerable:!0})},Ge=(n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ro(e))!Eo.call(n,s)&&s!==t&&ie(n,s,{get:()=>e[s],enumerable:!(o=Co(e,s))||o.enumerable});return n};var g=(n,e,t)=>(t=n!=null?xo(Po(n)):{},Ge(e||!n||!n.__esModule?ie(t,"default",{value:n,enumerable:!0}):t,n)),So=n=>Ge(ie({},"__esModule",{value:!0}),n);var ae=P(()=>{"use strict"});function S(){return Be.workspace.getConfiguration("chatgpt")}var Be,We,je,j=P(()=>{"use strict";Be=g(require("vscode")),We="apiEndpoint",je="logLevel"});function ce(n){return ze[n]<=ze[To]}function Io(){let n=Je.window.createOutputChannel("Codex",{log:!0});return{trace:(t,...o)=>{ce("trace")&&n.trace(t,...o)},debug:(t,...o)=>{ce("debug")&&n.debug(t,...o)},info:(t,...o)=>{ce("info")&&n.info(t,...o)},error:(t,...o)=>{n.error(t,...o)},warn:(t,...o)=>{ce("warning")&&n.warn(t,...o)},dispose:()=>n.dispose()}}var Je,ko,To,ze,p,E=P(()=>{"use strict";j();ae();Je=g(require("vscode")),ko="warning",To=S().get(je)??ko,ze={error:0,warning:1,info:2,debug:3,trace:4};p=Io()});function wt(n){return Object.prototype.hasOwnProperty.call(xe,n)?n:null}var vt,K,xe,yt,bt,xt,te,Ct,Rt,Pt,Et,St,V=P(()=>{"use strict";vt=require("crypto"),K=g(require("vscode")),xe={content:{category:"queryGet",version:1},ping:{category:"queryGet",version:1},selections:{category:"queryGet",version:1},reload:{category:"queryGet",version:1},markForReload:{category:"queryPost",version:1},removeHighlights:{category:"mutationPost",version:1},highlightLines:{category:"mutationPost",version:1},highlight:{category:"mutationPost",version:1},setContent:{category:"mutationPost",version:1},replaceSelection:{category:"mutationPost",version:1}},yt=Object.fromEntries(Object.entries(xe).map(([n,e])=>[n,e.version]));bt=`oai_pwai ${K.env.appName}`,xt=K.workspace.name??K.env.appName,te=K.env.appName+"-"+(0,vt.randomUUID)(),Ct="com.microsoft.VSCode",Rt="com.microsoft.VSCodeInsiders",Pt="com.vscodium",Et="com.todesktop.230313mzl4w4u92",St="com.exafunction.windsurf"});function L(n){return Ne().find(o=>o.document.fileName===n)||null}function Tt(){return Ne().map((e,t)=>{let o=e.selection.isEmpty?null:e.document.getText(e.selection),s=e.selection.isEmpty?null:e.selection.start.line;return o!=null&&s!=null?{selectedText:o,selectionLine:s}:null}).filter(e=>!!e)}function It(){return Ne().map((e,t)=>{let o=e.document.getText(),s=e.document.fileName,r=e.selection.isEmpty?null:e.document.getText(e.selection),i=e.document.offsetAt(e.selection.start),a=e.document.offsetAt(e.selection.end),c=e.selection.isEmpty?null:e.selection.start.line,u=e.selection.isEmpty?null:{location:i,length:a-i};return r===o&&(r=null),{id:s,content:o,filename:s,selectedText:r,selectionRange:u,selectionLine:c}}).filter(e=>!!e)}function Ne(){return kt.window.visibleTextEditors.filter(e=>e.viewColumn!==void 0)}var kt,Ce=P(()=>{"use strict";kt=g(require("vscode"))});function N(n){throw new Error(`No editor for id ${n} found`)}var Fe=P(()=>{"use strict"});async function At(n,e){let t=L(e);t||N(e);let o=t.document,s=new Q.Range(o.positionAt(0),o.positionAt(o.getText().length));await t.edit(i=>{i.replace(s,n)});let r=t.document.positionAt(n.length);t.selection=new Q.Selection(r,r)}async function Mt(n,e){let t=L(e);t||N(e);let o=t.selection,s=new Q.Range(o.start,o.end);await t.edit(r=>{r.replace(s,n)}),t.selection=new Q.Selection(s.start,s.start)}var Q,Dt=P(()=>{"use strict";Ce();Fe();Q=g(require("vscode"))});async function Lt(n,e){let t=L(e);t||N(e);let o=n.map(s=>{let r=new k.Range(s,0,s,t.document.lineAt(s).range.end.character);return Nt(r,e)});await Promise.all(o)}function Xo(n){return new Promise(e=>setTimeout(e,n))}async function Nt(n,e){let t=L(e);t||N(e),t.revealRange(n,k.TextEditorRevealType.InCenterIfOutsideViewport);let o=k.window.createTextEditorDecorationType({backgroundColor:`rgba(255, 255, 0, ${Ot})`,isWholeLine:!0});t.setDecorations(o,[n]);let s=k.workspace.onDidChangeTextDocument(r=>{r.document===t.document&&(o.dispose(),G[e]=[],s.dispose())});G[e]||(G[e]=[]),G[e].push({range:n,decoration:o})}async function Ft(n,e){let t=L(n);t||N(n),oe[n]||(oe[n]=1);let o=++oe[n];if(e){let i=(G[n]||[]).map(async a=>{let c=a.decoration,u=10,f=500/u;try{for(let d=0;d<=u&&o===oe[n];d++){let m=d/u,v=Ot*(1-m),x=k.window.createTextEditorDecorationType({backgroundColor:`rgba(255, 255, 0, ${v})`,isWholeLine:!0});t.setDecorations(x,[a.range]),c?.dispose(),c=x,await Xo(f)}}finally{c?.dispose()}});await Promise.all(i)}let s=G[n];s&&o===oe[n]&&(s.forEach(r=>r.decoration.dispose()),delete G[n])}async function qt(n,e,t){let o=L(t);o||N(t);let s=Zo(n,e,o.document);s&&await Nt(s,t)}function Zo(n,e,t){let o=0,s=0,r=0,i=0,a=0;for(let c=0;c<t.lineCount;c++){let h=t.lineAt(c).text.length+1;if(o<=n&&o+h>n&&(s=c,i=n-o),o<=e&&o+h>e){r=c,a=e-o;break}o+=h}if(s>=0&&r>=0){let c=new k.Position(s,i),u=new k.Position(r,a);return new k.Range(c,u)}return null}var k,G,oe,Ot,_t=P(()=>{"use strict";Ce();Fe();k=g(require("vscode")),G={},oe={},Ot=.2});async function Ht(n,e){switch(n){case"removeHighlights":try{let{textfieldID:t,animated:o}=e;return await Ft(t,o),{status:"success",message:"Removed highlight"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"highlightLines":try{let{lines:t,textfieldID:o}=e;return await Lt(t,o),{status:"success",message:"Text highlighted successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"highlight":try{let{startChar:t,endChar:o,textfieldID:s}=e;return await qt(t,o,s),{status:"success",message:"Text highlighted successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"setContent":try{let{content:t,textfieldID:o}=e;return await At(t,o),{status:"success",message:"Set content successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}case"replaceSelection":try{let{content:t,textfieldID:o}=e;return await Mt(t,o),{status:"success",message:"Replaced selection successfully"}}catch(t){return{status:400,error:JSON.stringify(t)}}}}var Vt=P(()=>{"use strict";V();Dt();_t()});async function Gt(n,e){let t=Buffer.alloc(0),o=null;n.on("data",async s=>{if(t=Buffer.concat([t,s]),o==null&&t.length>=4&&(o=t.readUInt32LE(0),t=t.subarray(4)),o!=null&&t.length>=o){let r=t.subarray(0,o).toString();t=t.subarray(o),o=null,await e(n,r)}}),n.on("end",()=>{p.debug("Desktop bridge: client disconnected")}),n.on("error",s=>{p.error("Desktop bridge socket error:",s)})}function ne(n,e){let t=JSON.stringify(e),o=Buffer.alloc(4),s=Buffer.byteLength(t);o.writeUInt32LE(s,0);let r=Buffer.from(t,"utf-8");n.write(o),n.write(r),n.end()}var qe=P(()=>{"use strict";E()});function _e(){return Pe.join(Wt.homedir(),"Library","Application Support","com.openai.chat","app_pairing_extensions",te)}function en(n){let e=_e();if(C.existsSync(e)){let t=C.watch(e,o=>{C.existsSync(e)||(n(),t.close())})}else p.warn("Desktop bridge: session path does not exist, cannot watch file.")}var C,Bt,Wt,Pe,Re,jt=P(()=>{"use strict";E();V();qe();C=g(require("fs")),Bt=g(require("net")),Wt=g(require("os")),Pe=g(require("path"));Re=class{getSessionSocketPath(){return`/tmp/${te}.sock`}async deregister(){let e=_e();p.info("Desktop bridge deregister",e),C.existsSync(e)&&C.unlinkSync(e),C.existsSync(this.getSessionSocketPath())&&C.unlinkSync(this.getSessionSocketPath())}async register(e,t){let o=_e(),s=Pe.dirname(o);C.existsSync(s)||C.mkdirSync(s,{recursive:!0}),C.writeFileSync(o,JSON.stringify(e),"utf8"),p.info(`Desktop bridge wrote payload to ${o}`);let r=this.getSessionSocketPath();C.existsSync(r)?C.chmodSync(r,384):p.warn("Desktop bridge: socket file does not exist"),en(t)}startServer(e,t){let o=this.getSessionSocketPath();C.existsSync(o)&&C.unlinkSync(o);let s=Bt.createServer(r=>{p.debug("Desktop bridge: client connected"),Gt(r,t)});s.listen(o,()=>{p.info(`Desktop bridge listening on UNIX socket: ${o}`)}),e.subscriptions.push({dispose:()=>{s.close(),this.deregister()}})}}});function tn(){if(zt.platform()!=="darwin")throw new Error("Unsupported platform");return new Re}var zt,B,$e=P(()=>{"use strict";jt();zt=g(require("os"));B=tn()});function Kt(){switch(Jt.env.appName){case"Visual Studio Code":return Ct;case"Visual Studio Code - Insiders":return Rt;case"VSCodium":return Pt;case"Cursor":return Et;case"Windsurf":return St;default:return null}}var Jt,Qt=P(()=>{"use strict";V();Jt=g(require("vscode"))});var on,se,Ue=P(()=>{"use strict";on="0.0.1731016154",se={name:"openai.chatgpt",version:on,isInstalled:!0}});function Zt(n){Xt=n,B.deregister(),Ee()}function Ee(){let n=Kt();if(!n)return;let e=B.getSessionSocketPath(),t={appName:F.env.appName,bundleID:n,extensionVersion:se.version,marketplaceID:se.name,extensionName:bt,workspaceName:xt,id:te,capabilities:yt,needsReload:Xt,socketPath:e,timestamp:Date.now()};B.register(t,()=>{let o=F.l10n.t("Reregister"),s=F.l10n.t("Dismiss");F.window.showWarningMessage(F.l10n.t("The ChatGPT extension cannot find its registration file"),o,s).then(r=>{r===o&&Ee()})})}var F,Xt,He=P(()=>{"use strict";Qt();V();$e();Ue();F=g(require("vscode")),Xt=!1});function eo(n){switch(n){case"ping":{let{name:e,version:t}=se;return{status:"success",version:t,name:e}}case"content":{let e=It();return e!=null?{status:"success",textfields:e}:{status:400,error:"No active editor found"}}case"selections":{let e=Tt();return e!=null?{status:"success",selections:e}:{status:400,error:"No active editor found"}}case"reload":return Yt.commands.executeCommand("workbench.action.reloadWindow"),{status:"success"}}}async function to(n){switch(n){case"markForReload":return Zt(!0),{status:"success",message:"Marked for reload"}}}var Yt,oo=P(()=>{"use strict";V();Ce();He();Ue();Yt=g(require("vscode"))});var io={};Ve(io,{activate:()=>sn,deactivate:()=>rn,respondToCompleteMessage:()=>ro});function sn(n){nn==="darwin"&&(p.info("ChatGPT desktop bridge active"),B.startServer(n,ro),Ee(),p.info("Desktop bridge registered"))}function rn(){B.deregister()}async function ro(n,e){try{let t=JSON.parse(e),o=wt(t.command);if(!o){ne(n,{status:404,error:"Unknown endpoint"});return}if(!so.workspace.isTrusted&&o!=="ping"){p.warn("Desktop bridge: untrusted workspace"),ne(n,{status:405,error:"The workspace must be trusted for the extension to read content."});return}let s=await an(o,t.payload);s.status===400&&p.error("Desktop bridge error for command:",t.command),ne(n,s)}catch(t){p.error("Desktop bridge: error processing message:",t),ne(n,{success:!1,error:"Error handling message"})}}async function an(n,e){let{category:t}=xe[n];switch(t){case"queryGet":return eo(n);case"queryPost":return to(n);case"mutationPost":return Ht(n,e)}}var no,so,nn,ao=P(()=>{"use strict";V();Vt();$e();oo();He();qe();E();no=g(require("os")),so=g(require("vscode")),nn=no.platform()});var pn={};Ve(pn,{activate:()=>cn});module.exports=So(pn);ae();E();var Qe=g(require("os")),Xe=g(require("path")),w=g(require("vscode")),Ao=5173,Mo=`http://localhost:${Ao}`,Do="/src/main.tsx",$=class n{constructor(e,t,o,s){this.extensionUri=e;this.codexMcpConnection=t;this.fetchWrapper=o;this.ideContextConnection=s;this.subscriptions.push(w.commands.registerCommand("chatgpt.implementTodo",async({line:r,fileName:i,comment:a})=>{await A();let c={fileName:i,line:r,comment:a};this.sidebarPanel&&this.webviewReady?this.postMessageToView(this.sidebarPanel.webview,{type:"implement-todo",...c}):this.pendingImplementTodo=c})),this.subscriptions.push(w.workspace.onDidChangeWorkspaceFolders(()=>{this.sidebarPanel&&this.postMessageToView(this.sidebarPanel.webview,{type:"workspace-roots-updated"}),this.editorPanel&&this.postMessageToView(this.editorPanel.webview,{type:"workspace-roots-updated"})}))}static viewType="chatgpt.sidebarView";static providerName="webview";sidebarPanel;editorPanel;subscriptions=[];mcpProviderDisposable;webviewReady=!1;pendingImplementTodo=null;pendingContextFiles=[];pendingNavigationRoutes=[];async resolveWebviewView(e,t,o){this.sidebarPanel=e;let{webview:s}=e,r=w.Uri.joinPath(this.extensionUri,"webview");s.options={enableScripts:!0,enableCommandUris:!1,localResourceRoots:[r]},s.onDidReceiveMessage(i=>{if(i.type==="ready"){if(this.webviewReady=!0,this.pendingImplementTodo&&(this.postMessageToView(s,{type:"implement-todo",...this.pendingImplementTodo}),this.pendingImplementTodo=null),this.pendingContextFiles.length>0){for(let a of this.pendingContextFiles)this.postMessageToView(s,{type:"add-context-file",file:a});this.pendingContextFiles=[]}if(this.pendingNavigationRoutes.length>0){for(let{path:a,state:c}of this.pendingNavigationRoutes)this.postMessageToView(s,{type:"navigate-to-route",path:a,state:c});this.pendingNavigationRoutes=[]}}this.handleMessage(s,i)}),this.mcpProviderDisposable?.dispose(),this.mcpProviderDisposable=this.codexMcpConnection.registerProvider(n.providerName,{onResult:i=>{this.postMessageToView(s,{type:"mcp-message",message:i})},onRequest:i=>{this.postMessageToView(s,{type:"mcp-request",id:i.id,method:i.method,params:i.params})},onNotification:i=>{let{method:a,params:c}=i;this.postMessageToView(s,{type:"mcp-notification",method:a,params:c})}}),this.subscriptions.push(this.ideContextConnection.onIdeContextChange(()=>{this.postMessageToView(s,{type:"ide-context-updated"})})),s.html=await this.getWebviewContent(s),this.subscriptions.push(e.onDidDispose(()=>{this.sidebarPanel=void 0,this.webviewReady=!1,this.mcpProviderDisposable?.dispose(),this.mcpProviderDisposable=void 0}))}triggerNewChatViaWebview(){this.sidebarPanel&&this.webviewReady&&this.postMessageToView(this.sidebarPanel.webview,{type:"new-chat"})}postMessageToView(e,t){let o=JSON.stringify(t);e.postMessage(o)}addContextFile(e){let t={type:"add-context-file",file:e};this.sidebarPanel&&this.webviewReady?this.postMessageToView(this.sidebarPanel.webview,t):this.pendingContextFiles.push(e)}navigateToRoute(e,t){let o={type:"navigate-to-route",path:e,state:t};this.sidebarPanel&&this.webviewReady?this.postMessageToView(this.sidebarPanel.webview,o):this.pendingNavigationRoutes.push({path:e,state:t})}async handleMessage(e,t){switch(t.type){case"ready":break;case"mcp-request":{let{id:o,method:s,params:r}=t.request;this.codexMcpConnection.sendRequest(n.providerName,String(o),s,r);break}case"mcp-notification":{let{method:o,params:s}=t.request;this.codexMcpConnection.sendNotification(o,s);break}case"mcp-response":{let{id:o,result:s}=t.response;this.codexMcpConnection.sendResponse(o,s);break}case"open-in-browser":{w.env.openExternal(w.Uri.parse(t.url));break}case"open-extension-settings":{w.commands.executeCommand("workbench.action.openSettings","@ext:openai.chatgpt");break}case"open-keyboard-shortcuts":{w.commands.executeCommand("workbench.action.openGlobalKeybindings","chatgpt");break}case"open-config-toml":{let o=Xe.join(Qe.homedir(),".codex","config.toml");w.commands.executeCommand("vscode.open",w.Uri.file(o));break}case"show-diff":{this.showDiff({unifiedDiff:t.unifiedDiff});break}case"update-diff-if-open":{this.editorPanel&&this.postMessageToView(this.editorPanel.webview,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:t.unifiedDiff}});break}case"fetch":{let o=await this.fetchWrapper.fetch(t);this.postMessageToView(e,o);break}case"cancel-fetch":{this.fetchWrapper.cancel(t.requestId);break}case"fetch-stream":{this.fetchWrapper.stream(t,o=>this.postMessageToView(e,o));break}case"cancel-fetch-stream":{this.fetchWrapper.cancelStream(t.requestId);break}case"log-message":{let{level:o,message:s}=t;switch(o){case"trace":p.trace(s);break;case"debug":p.debug(s);break;case"info":p.info(s);break;case"warning":p.warn(s);break;case"error":p.error(s);break}break}}}async getWebviewContent(e){return this.getWebviewContentProduction(e)}async getWebviewContentProduction(e){let t=w.Uri.joinPath(this.extensionUri,"webview"),o=w.Uri.joinPath(t,"index.html"),s=await w.workspace.fs.readFile(o),r=new TextDecoder("utf-8").decode(s),i=e.asWebviewUri(t).toString()+"/",a=Ke(i),c=["default-src 'none'",`img-src ${e.cspSource} https: data: blob:`,`script-src ${e.cspSource}`,`style-src ${e.cspSource} 'unsafe-inline'`,`font-src ${e.cspSource}`,`connect-src ${e.cspSource}`].join("; ")+";",u=Ke(c);return r.replace("<!-- PROD_BASE_TAG_HERE -->",`<base href="${a}">`).replace("<!-- PROD_CSP_TAG_HERE -->",`<meta http-equiv="Content-Security-Policy" content="${u}">`)}getWebviewContentDevelopment(){return`<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="${w.Uri.parse(Mo).toString()}">

    <!-- Hot reloading code from Vite -->
    <script type="module">
        import RefreshRuntime from "/@react-refresh"
        RefreshRuntime.injectIntoGlobalHook(window)
        window.$RefreshReg$ = () => {}
        window.$RefreshSig$ = () => (type) => type
        window.__vite_plugin_react_preamble_installed__ = true
    </script>
    <script type="module" src="/@vite/client"></script>
    <script type="module" src="${Do}"></script>
    <script src="http://localhost:8097"></script>
</head>
<body tabindex="0" style="outline: none">
    <div id="root"></div>
</body>
</html>`}dispose(){this.subscriptions.forEach(e=>e.dispose())}async showDiff(e){if(this.editorPanel)this.editorPanel.reveal(w.ViewColumn.One),this.postMessageToView(this.editorPanel.webview,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:e.unifiedDiff}});else{let t=w.Uri.joinPath(this.extensionUri,"webview");this.editorPanel=w.window.createWebviewPanel("codexEditorView","Codex",w.ViewColumn.One,{enableScripts:!0,retainContextWhenHidden:!0,localResourceRoots:[t]}),this.subscriptions.push(this.editorPanel.onDidDispose(()=>{this.editorPanel=void 0}));let{webview:o}=this.editorPanel;o.html=await this.getWebviewContent(o),this.subscriptions.push(o.onDidReceiveMessage(async s=>{s.type==="ready"&&this.postMessageToView(o,{type:"navigate-to-route",path:"/diff",state:{unifiedDiff:e.unifiedDiff}}),this.handleMessage(o,s)}))}}};function Ke(n){return n.replace(/["<&]/g,e=>{switch(e){case'"':return"&quot;";case"<":return"&lt;";case"&":return"&amp;";default:return e}})}E();var ke=g(require("vscode"));async function A(){try{await ke.commands.executeCommand("workbench.view.extension.codexViewContainer"),await ke.commands.executeCommand(`${$.viewType}.focus`)}catch(n){p.error(`Failed to focus Codex view: ${n instanceof Error?n.message:String(n)}`)}}var Ze=g(require("path")),pe=g(require("vscode"));async function Ye(n){let e=pe.window.activeTextEditor;if(!e)return;let t=e.document.uri;if(t.scheme!=="file")return;let o=e.selection.start.line+1,s=e.selection.end.line+1;e.selection.end.character===0&&e.selection.end.line>e.selection.start.line&&s--;let r=t.fsPath,i=Ze.basename(r),a=o!=null?`${i}:${o}`+(s!=null&&s!==o?`:${s}`:""):i;await A(),n.addContextFile({label:a,path:pe.workspace.asRelativePath(r),fsPath:r,startLine:o,endLine:s})}var et=require("crypto"),Te=class n{constructor(e){this.mcpConnection=e;let t=this.mcpConnection.registerProvider(n.providerName,{onNotification:o=>this.handleNotification(o),onResult:o=>this.handleResult(o)});this.disposables.push(t)}static providerName="auth";authStatus;disposables=[];pending=new Map;updateToken(e){let t=(0,et.randomUUID)(),o=new Promise((s,r)=>{this.pending.set(t,{resolve:s,reject:r})});return this.mcpConnection.sendRequest(n.providerName,t,"getAuthStatus",{includeToken:!0,refreshToken:!!e}),o}async getToken(e){return this.authStatus&&!e?this.authStatus.authToken:this.updateToken(e)}resolve(e,t){let o=this.pending.get(e);o&&(this.pending.delete(e),o.resolve(t))}reject(e,t){let o=this.pending.get(e);o&&(this.pending.delete(e),o.reject(t))}handleResult(e){if(typeof e.id!="string")return;if(e.error){this.reject(e.id,e.error);return}let t=e.result??null;this.authStatus=t??void 0,this.resolve(e.id,this.authStatus?.authToken??null)}handleNotification(e){e.method==="codex/event/auth_status_change"&&(this.authStatus=void 0,this.updateToken())}dispose(){for(let e of this.disposables)e.dispose();this.disposables.length=0,this.pending.clear()}};function tt(n){return new Te(n)}j();ae();function Z(){if(!0){let{platform:n,arch:e}=process,t,o;switch(n){case"win32":t="windows";break;case"darwin":t="macos";break;default:t="linux";break}switch(e){case"x64":o="x86_64";break;case"arm64":o="aarch64";break;default:throw new Error(`unrecognized architecture: ${e}`)}return`bin/${`${t}-${o}`}`}return"bin"}E();var ot=require("child_process");var U={CLI_EXECUTABLE:"cliExecutable",COMMENT_CODELENS_ENABLED:"commentCodeLensEnabled",OPEN_ON_STARTUP:"openOnStartup"};var nt=g(require("readline")),Y=g(require("vscode"));async function st(n){let e=Oo(n),t=process.platform==="win32"?";":":",o=process.env.PATH+t+Y.Uri.joinPath(n,Z()).fsPath,s=(0,ot.spawn)(e,["mcp"],{stdio:["pipe","pipe","pipe"],env:{...process.env,PATH:o,RUST_LOG:"warn"}});if(s.pid==null)throw new Error("Failed to spawn codex mcp process.");let r=new Ie(s),i=1;{let a={jsonrpc:"2.0",id:i,method:"initialize",params:{protocolVersion:"2025-06-18",capabilities:{roots:{listChanged:!0},elicitation:{}},clientInfo:{name:"Codex",title:"Codex from OpenAI",version:"0.0.0"}}};s.stdin.destroyed||s.stdin.write(JSON.stringify(a)+`
`)}return await r.whenInitialized,r}var Ie=class{constructor(e){this.proc=e;e.on("error",t=>{p.error(`codex mcp process error: ${t}`)}),e.on("exit",(t,o)=>{t!==0?p.error(`codex mcp process exited with code ${t} and signal ${o}`):p.info("codex mcp process exited successfully.")}),e.stderr&&e.stderr.on("data",t=>{let o=Lo(t.toString().trim());if(o){let{level:s,message:r}=No(o),i="CLI:";switch(s){case"trace":case"debug":case"info":p.info(`${i} ${r}`);break;case"warn":p.warn(`${i} ${r}`);break;case"error":p.error(`${i} ${r}`);break}}}),this.whenInitialized=new Promise((t,o)=>{this.resolveInit=t,this.rejectInit=o}),this.rl=nt.createInterface({input:e.stdout}),this.rl.on("line",t=>{let o=t.trim(),s;try{s=JSON.parse(o)}catch(r){p.error(`unable to parse stdout from codex mcp: ${r}`);return}if(!this.initialized){if("id"in s&&("result"in s||"error"in s)&&s.id===1){if("error"in s&&s.error){let r=new Error(`Failed to initialize local agent: ${JSON.stringify(s.error)}`);this.rejectInit?.(r)}else this.initialized=!0,this.resolveInit?.();return}p.warn(`Dropping MCP message received before initialization: ${o}`);return}this.routeIncomingMessage(s)})}rl;providers=new Map;initialized=!1;whenInitialized;resolveInit;rejectInit;registerProvider(e,t){if(this.providers.has(e))throw new Error(`Provider already registered: ${e}`);return this.providers.set(e,t),new Y.Disposable(()=>{this.providers.delete(e)})}sendRequest(e,t,o,s){let i={jsonrpc:"2.0",id:`${e}:${t}`,method:o,params:s};this.sendMessage(i)}sendNotification(e,t){let o={jsonrpc:"2.0",method:e,params:t};this.sendMessage(o)}sendResponse(e,t){let o={jsonrpc:"2.0",id:e,result:t};this.sendMessage(o)}sendMessage(e){let{stdin:t}=this.proc;t.destroyed||t.write(JSON.stringify(e)+`
`)}routeIncomingMessage(e){if(this.isMcpResponseMessage(e)){let t=e.id;if(typeof t=="string"&&t.includes(":")){let[o,...s]=t.split(":"),r=s.join(":"),i=this.providers.get(o);if(i?.onResult){let a={...e,id:r};i.onResult(a)}return}p.warn(`Received MCP response with id=${JSON.stringify(t)} but no provider namespace`);return}if(this.isMcpRequestMessage(e)){for(let[,t]of this.providers)t.onRequest?.(e);return}if(typeof e.method=="string"){let{method:t,params:o}=e;for(let[,s]of this.providers)s.onNotification?.({jsonrpc:"2.0",method:t,params:o});return}p.error(`Received unknown MCP message: ${JSON.stringify(e)}`)}isMcpResponseMessage(e){return"id"in e&&("result"in e||"error"in e)}isMcpRequestMessage(e){return typeof e.method=="string"&&"id"in e&&e.id!=null}dispose(){this.rl.close(),this.proc.kill()}};function Oo(n){let e=S().get(U.CLI_EXECUTABLE);if(e&&e.trim().length>0)return e;{let t=process.platform==="win32"?"codex.exe":"codex",o=Z();return Y.Uri.joinPath(n,`${o}/${t}`).fsPath}}function Lo(n){return n.replace(/\x1b\[[0-9;]*m/g,"")}function No(n){let e=n.match(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z\s+(\w+)\s+(.+)$/);if(e){let t=e[1].toLowerCase();return t==="trace"||t==="debug"||t==="info"||t==="warn"||t==="error"?{level:t,message:e[2]}:{level:"error",message:e[2]}}return{level:"error",message:n}}j();var de=class{constructor(e,t=[],o=[],s){this.child=e;this.stdoutChunks=t;this.stderrChunks=o;this.promise=s.then(({code:r,signal:i})=>({type:"resolve",code:r,signal:i}),r=>({type:"reject",error:r}))}result=null;promise;check(){return this.wait().then(({stdout:e,stderr:t,code:o,signal:s})=>{if(o===0)return{stdout:e,stderr:t};throw new Error(`process exited with code ${o}, signal ${s}`)})}wait(){return this.promise.then(e=>{switch(e.type){case"resolve":{let{code:t,signal:o}=e;return{stdout:Buffer.concat(this.stdoutChunks).toString("utf8"),stderr:Buffer.concat(this.stderrChunks).toString("utf8"),code:t,signal:o}}case"reject":throw e.error}})}getStdout(){return Buffer.concat(this.stdoutChunks)}getStderr(){return Buffer.concat(this.stderrChunks)}getExitCode(){return this.result?.type==="resolve"?this.result.code:null}isDone(){return this.result!=null}kill(){this.child.kill()}};var rt=require("child_process");function I({args:n,cwd:e}){let t=(0,rt.spawn)(n[0],n.slice(1),{cwd:e,env:{...process.env},stdio:["ignore","pipe","pipe"]});if(!t.pid)throw new Error(`failed to start process from ${e}: \`${n.join(" ")}\``);let o=[],s=[],r=new Promise((i,a)=>{t.stdout?.on("data",c=>{o.push(c)}),t.stderr?.on("data",c=>{s.push(c)}),t.on("exit",(c,u)=>{i({code:c,signal:u})}),t.on("error",c=>{a(c)})});return new de(t,o,s,r)}E();async function le(n){try{let e=I({args:["git","rev-parse","--show-toplevel"],cwd:n}),{stdout:t,code:o}=await e.wait();if(o===0)return t.trim()}catch{p.info(`getGitRoot: ${n} is not a git repository`)}return null}E();function it(n,e){let t=new Set,o=new Set,s=new Set,r=null,i=[n,e].filter(Boolean).join(`
`),a=(T,y)=>{let l=(y??"").trim();if(!l)return;let R=l.charAt(0),bo=l.charAt(l.length-1),Se=l;(R==="'"||R==='"')&&bo===R&&l.length>=2&&(Se=l.slice(1,-1)),Se&&T.add(Se)},c=(T,y)=>{for(let l of y)if(T[l])return T[l]},u=/^(?:Applied patch(?: to)?\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+cleanly\.?)$/i,h=/^(?:Applied patch(?: to)?\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+with conflicts\.?)$/i,f=/^(?:Applying patch\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\s+with\s+\d+\s+rejects?\.{0,3})$/i,d=/^(?:Checking patch\s+(?:(["'])(?<qpath>.+?)\1|(?<path>.+?))\.\.\.)$/i,m=/^(?:Performing three-way merge|Falling back to three-way merge)\.\.\.$/i,v=/^Failed to perform three-way merge\.\.\.$/i,x=/^Falling back to direct application\.\.\.$/i,q=/^U\s+(?<path>.+)$/,re=/^error:\s+patch failed:\s+(?<path>.+?)(?::\d+)?(?:\s|$)/i,_=/^error:\s+(?<path>.+?):\s+patch does not apply$/i,W=/^(?:error: )?repository lacks the necessary blob to (?:perform|fall back on) 3-?way merge\.?$/i,co=/^error:\s+(?<path>.+?):\s+does not match index\b/i,po=/^error:\s+(?<path>.+?):\s+does not exist in index\b/i,lo=/^error:\s+(?<path>.+?)\s+already exists in (?:the )?working directory\b/i,uo=/^error:\s+patch failed:\s+(?<path>.+?)\s+File exists/i,mo=/^error:\s+path\s+(?<path>.+?)\s+has been renamed\/deleted/i,fo=/^error:\s+cannot apply binary patch to\s+['"]?(?<path>.+?)['"]?\s+without full index line$/i,ho=/^error:\s+binary patch does not apply to\s+['"]?(?<path>.+?)['"]?$/i,go=/^error:\s+binary patch to\s+['"]?(?<path>.+?)['"]?\s+creates incorrect result\b/i,vo=/^error:\s+cannot read the current contents of\s+['"]?(?<path>.+?)['"]?$/i,yo=/^Skipped patch\s+['"]?(?<path>.+?)['"]\.$/i,wo=/^warning:\s*Cannot merge binary files:\s+(?<path>.+?)\s+\(ours\s+vs\.\s+theirs\)/i;for(let T of i.split(/\r?\n/)){let y=T.trim();if(!y)continue;let l;if(l=y.match(u)){let R=c(l.groups??{},["qpath","path"]);a(t,R),r=R??r,s.delete(R??""),o.delete(R??"");continue}if(l=y.match(h)){let R=c(l.groups??{},["qpath","path"]);a(s,R),r=R??r,t.delete(R??""),o.delete(R??"");continue}if(l=y.match(f)){let R=c(l.groups??{},["qpath","path"]);a(s,R),r=R??r,t.delete(R??""),o.delete(R??"");continue}if(l=y.match(q)){a(s,l.groups?.path),r=l.groups?.path??r,t.delete(l.groups?.path??""),o.delete(l.groups?.path??"");continue}if(l=y.match(d)){r=c(l.groups??{},["qpath","path"])??r;continue}if((l=y.match(re))||(l=y.match(_))){a(o,l.groups?.path),r=l.groups?.path??r;continue}if(!(m.test(y)||x.test(y))){if(v.test(y)){r&&(a(o,r),t.delete(r),s.delete(r));continue}if(W.test(y)){r&&(a(o,r),t.delete(r),s.delete(r));continue}if((l=y.match(co))||(l=y.match(po))||(l=y.match(lo))||(l=y.match(uo))||(l=y.match(mo))||(l=y.match(fo))||(l=y.match(ho))||(l=y.match(go))||(l=y.match(vo))||(l=y.match(yo))){a(o,l.groups?.path),r=l.groups?.path??r,t.delete(l.groups?.path??""),s.delete(l.groups?.path??"");continue}if(l=y.match(wo)){a(s,l.groups?.path),r=l.groups?.path??r,t.delete(l.groups?.path??""),o.delete(l.groups?.path??"");continue}}}for(let T of s)t.delete(T),o.delete(T);for(let T of t)o.delete(T);return{appliedPaths:Array.from(t).sort(),skippedPaths:Array.from(o).sort(),conflictedPaths:Array.from(s).sort()}}var O=g(require("fs/promises")),at=g(require("os")),ue=g(require("path"));async function ct({cwd:n,diff:e,revert:t}){let o=await le(n);if(!o)throw new Error(`${n} is not a git repository`);let s=await O.mkdtemp(ue.join(at.tmpdir(),"codex-apply-")),r=ue.join(s,"patch.diff");await O.writeFile(r,e,"utf8"),t&&await Fo(o,e);let i=["git","apply",t?"-R":null,"--3way",r].filter(Boolean),a=I({args:i,cwd:o}),{code:c,stdout:u,stderr:h}=await a.wait();p.info(`applyPatch revert: ${t}, code: ${c}, stdout: ${u}, stderr: ${h}`);let{appliedPaths:f,skippedPaths:d,conflictedPaths:m}=it(u,h);return await O.rm(s,{recursive:!0,force:!0}),{status:c===0?"success":c===1?"partial-success":"error",appliedPaths:f,skippedPaths:d,conflictedPaths:m}}async function Fo(n,e){let t=qo(e),o=(await Promise.all(t.map(async s=>{try{return await O.access(ue.join(n,s)),s}catch{return p.info(`Skipping staging ${s} because it does not exist in the working tree`),null}}))).filter(s=>!!s);if(o.length>0){let s=["git","add","--",...o],i=await I({args:s,cwd:n}).wait();p.info(`Staged ${o.length} files: ${i.code}`)}}function qo(n){let e=new Set,t=/^diff --git a\/(.*?) b\/(.*)$/gm,o;for(;(o=t.exec(n))!=null;){let[s,r,i]=o;r&&r!=="/dev/null"&&e.add(r),i&&i!=="/dev/null"&&e.add(i)}return Array.from(e)}j();E();E();var pt=g(require("fs")),z=g(require("path")),H=g(require("vscode"));async function dt(n,e=10){let t=H.workspace.workspaceFolders??[];if(n.trim().length===0||t.length===0)return[];let o=[],s=`**/*${_o(n)}*`,r=$o();for(let i of t){if(o.length>=e)break;try{let c=I({args:[r??"rg","--files","--iglob",s],cwd:i.uri.fsPath}),{stdout:u,code:h}=await c.wait();if(h!==0)return[];let f=u.split(/\r?\n/).map(d=>d.trim()).filter(Boolean);for(let d of f){if(o.length>=e)break;let m=z.isAbsolute(d)?d:z.join(i.uri.fsPath,d),v=z.basename(m).replace(/\\/g,"/"),x=H.workspace.asRelativePath(m).replace(/\\/g,"/");o.push({label:v,path:x,fsPath:m})}}catch(a){p.warn(`rg search failed in ${i.uri.fsPath}: ${String(a)}`)}}return o}function _o(n){let e=["*","?","[","]","{","}","!","\\"],t="";for(let o of n)t+=e.includes(o)?"\\"+o:o;return t}function $o(){try{let n=H.extensions.getExtension("openai.chatgpt");if(!n)return null;let e=process.platform==="win32"?"rg.exe":"rg",t=Z(),o=H.Uri.joinPath(n.extensionUri,t,e).fsPath;return pt.existsSync(o)?o:null}catch{return null}}var Ae=g(require("os")),lt=g(require("path"));var b=g(require("vscode")),me=class{constructor(e,t){this.authProvider=e;this.ideContextConnection=t}handlers={"workspace-roots":async()=>({roots:b.workspace.workspaceFolders?.map(e=>e.uri.fsPath)??[]}),"has-custom-cli-executable":async()=>({hasCustomCliExecutable:(S().get(U.CLI_EXECUTABLE)??"").trim().length>0}),"account-info":async()=>{let e=await this.authProvider.getToken();if(!e)return{accountId:null,plan:null,email:null};try{let t=JSON.parse(Buffer.from(e.split(".")[1],"base64url").toString("utf8")),o=t["https://api.openai.com/auth"]??{},s=t["https://api.openai.com/profile"]??{},r=o?.chatgpt_account_id??null,i=o?.chatgpt_plan_type??null,a=s?.email??null;if(r&&i)return{type:"success",accountId:r,plan:i,email:a}}catch{p.error("Unable to extract account id and plan from auth token.")}return{accountId:null,plan:null,email:null}},"find-files":async({query:e})=>({files:await dt(e,10)??[]}),"ide-context":async()=>({ideContext:this.ideContextConnection.getIdeContext()}),"apply-patch":async e=>ct(e),"open-file":async({path:e,line:t,column:o})=>{let s=typeof t=="number"?t:void 0,r=typeof o=="number"?o:1,i=e.replace(/^([ab])[\\/]/,""),a=b.workspace.workspaceFolders??[],c=async f=>{try{let d=await b.workspace.openTextDocument(f),m=s!=null?new b.Range(new b.Position(Math.max(0,s-1),Math.max(0,r-1)),new b.Position(Math.max(0,s-1),Math.max(0,r-1))):void 0;return await b.window.showTextDocument(d,m?{preview:!1,selection:m}:void 0),!0}catch{return!1}};if(lt.isAbsolute(i)){let f=await c(b.Uri.file(i));return f||p.error(`Failed to open absolute path: ${i}`),{success:f}}let u=i.split(/[\\/]+/).filter(Boolean),h=!1;for(let f of a){if(h)break;let d=b.Uri.joinPath(f.uri,...u);if(await c(d)){h=!0;break}let m=u.indexOf(f.name);if(m!==-1){let v=b.Uri.joinPath(f.uri,...u.slice(m+1));if(await c(v)){h=!0;break}}}if(!h&&i.length>0)try{let f=`**/${i.replace(/\\/g,"/")}`,d=await b.workspace.findFiles(f,void 0,1);d.length>0&&(h=await c(d[0]))}catch{}if(!h){let f=a.map(d=>d.uri.fsPath).join(", ");p.error(`Failed to resolve and open file from path "${e}" (normalized: "${i}") in workspaces: [${f}]`)}return{success:h}},"git-origins":async()=>{let e=b.workspace.workspaceFolders??[],t=[],o=new Set,s=Ae.homedir();return await Promise.all(e.map(async r=>{let i=r.uri.fsPath;try{let a=I({args:["git","rev-parse","--show-toplevel"],cwd:r.uri.fsPath}),{stdout:c,code:u}=await a.wait();u===0&&(i=c.trim())}catch{}try{let a=I({args:["git","config","--get","remote.origin.url"],cwd:i}),{stdout:c,code:u}=await a.wait(),h=u===0?c.trim():null;o.has(i)||(t.push({root:i,originUrl:h}),o.add(i))}catch{o.has(i)||(t.push({root:i,originUrl:null}),o.add(i))}})),{origins:t,homeDir:s}},"git-roots":async()=>{let e=b.workspace.workspaceFolders??[],t=Ae.homedir();return{roots:(await Promise.all(e.map(s=>le(s.uri.fsPath)))).filter(s=>s!=null),homeDir:t}},"git-current-branch":async({gitRoot:e})=>{let t=b.workspace.workspaceFolders??[],o=e??t[0]?.uri.fsPath;if(!o)return{branch:null};try{let s=I({args:["git","rev-parse","--abbrev-ref","HEAD"],cwd:o}),{stdout:r,code:i}=await s.wait();if(i===0){let a=r.trim();return{branch:a&&a!=="HEAD"?a:null}}}catch{}return{branch:null}},"get-configuration":async({key:e})=>({value:S().get(e)}),"set-configuration":async({key:e,value:t})=>(await S().update(e,t),{success:!0}),"set-vs-context":async({key:e,value:t})=>(await b.commands.executeCommand("setContext",e,t),{success:!0})};handleVSCodeRequest(e,t){return this.handlers[e](t)}};j();var Uo="http://localhost:8000/api",Ho="https://chatgpt.com/backend-api";function Vo(){switch(S().get(We)){case"localhost":return Uo;case"production":default:return Ho}}function Me(n){return n.startsWith("data:")||n.startsWith("http")?n:`${Vo()}/${n.replace(/^\//,"")}`}E();function Go(n){let e=n.split(/\r?\n/),t,o=[];for(let r of e)r.startsWith("event:")?t=r.slice(6).trim():r.startsWith("data:")&&o.push(r.slice(5).trim());if(o.length===0)return null;let s=o.join(`
`);try{return{event:t,data:JSON.parse(s)}}catch{return null}}function Bo(n){let e=n.indexOf(`\r
\r
`),t=n.indexOf(`

`);return e===-1&&t===-1?[-1,0]:e===-1?[t,2]:t===-1?[e,4]:e<t?[e,4]:[t,2]}function Wo(n,e){return{async next(){if(e.aborted)return{done:!0,value:void 0};let{value:t,done:o}=await n.read();return o||t==null?{done:!0,value:void 0}:{done:!1,value:t}},[Symbol.asyncIterator](){return this}}}async function*ut(n,e){let t=n.getReader(),o=new TextDecoder,s="",r=Wo(t,e);try{for await(let i of r){s+=o.decode(i,{stream:!0});let a,c;for(;[a,c]=Bo(s),a>=0;){let u=s.slice(0,a);s=s.slice(a+c);let h=Go(u);!h||h.event==="heartbeat"||(yield h)}}}finally{t.releaseLock()}}function mt(n){return!!n&&typeof n=="object"&&n.name==="AbortError"}function ee(n){return new Promise(e=>setTimeout(e,n))}var ft="vscode://codex/",J=3,jo=300,zo=2e3,fe=class{constructor(e,t){this.authProvider=e;this.extensionFetchHandler=t}abortSignals=new Map;streamControllers=new Map;shouldRetryStatus(e){return e===408||e===425||e===429||e>=500&&e<=599}backoffDelay(e){let t=Math.min(zo,jo*2**e),o=t*.2*(Math.random()-.5)*2;return Math.max(0,Math.floor(t+o))}buildHeaders(e,t,o){let s={...e??{}},r=i=>Object.keys(s).some(a=>a.toLowerCase()===i);if(o.attachAuth&&t&&!r("authorization")){s.Authorization=`Bearer ${t}`;try{let i=JSON.parse(Buffer.from(t.split(".")[1],"base64url").toString("utf8"))["https://api.openai.com/auth"]?.chatgpt_account_id;i&&(s["ChatGPT-Account-Id"]=i)}catch{}}return o.method!=="GET"&&!r("content-type")&&(s["Content-Type"]="application/json"),r("originator")||(s.originator="codex_vscode"),s}shouldAttachAuth(e){let o=new URL(e).host.toLowerCase();return o==="localhost:8000"||o==="localhost"||o.endsWith(".openai.com")||o==="openai.com"||o==="chatgpt.com"||o.endsWith(".chatgpt.com")}async fetch(e){try{let t=new AbortController;if(this.abortSignals.set(e.requestId,t),t.signal.addEventListener("abort",()=>({type:"fetch-response",responseType:"error",error:"Request cancelled",requestId:e.requestId,status:499})),e.url.startsWith(ft)){let a=await this.extensionFetchHandler.handleVSCodeRequest(e.url.slice(ft.length),e.body?JSON.parse(e.body):void 0);return{type:"fetch-response",responseType:"success",requestId:e.requestId,status:200,headers:{},bodyJsonString:JSON.stringify(a)}}let o=Me(e.url),s=await this.authProvider.getToken(),r=this.shouldAttachAuth(o),i=async(a,c)=>{if(r&&!Jo(c))return{type:"fetch-response",responseType:"error",requestId:e.requestId,status:401,error:`Cannot fetch ${e.url} without ChatGPT auth.`};let u=this.buildHeaders(e.headers,c,{method:e.method,attachAuth:r}),h=Object.keys(u).some(f=>f.toLowerCase()==="authorization");try{let f=e.body,d=Object.keys(u).find(x=>x.toLowerCase()==="x-codex-base64");if(d&&u[d]==="1"){if(e.body)try{f=Buffer.from(e.body,"base64")}catch{f=e.body}delete u[d]}let v=await fetch(o,{method:e.method,headers:u,body:f,signal:t.signal});if(v.status>=200&&v.status<300){let x=v.headers.get("content-type")||"",q;if(x.includes("application/json")){let _=await v.json();q=JSON.stringify(_)}else{let _=await v.arrayBuffer(),W=Buffer.from(_).toString("base64");q=JSON.stringify({base64:W,contentType:x})}this.abortSignals.delete(e.requestId);let re={};return v.headers.forEach((_,W)=>{W!=="authorization"&&(re[W]=_)}),{type:"fetch-response",responseType:"success",requestId:e.requestId,status:v.status,headers:re,bodyJsonString:q}}if(v.status===401&&h&&a<J){let x=await this.authProvider.getToken(!0);if(x&&x!==c)return i(a+1,x)}if(this.shouldRetryStatus(v.status)&&a<J){let x=this.backoffDelay(a);return await ee(x),i(a+1,c)}return v.status===404?p.info(`Error fetching ${e.url}: ${v.status} ${v.statusText}`):p.error(`Error fetching ${e.url}: ${v.status} ${v.statusText}`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:v.status,error:v.statusText}}catch(f){if(t.signal.aborted)return{type:"fetch-response",responseType:"error",error:"Request cancelled",requestId:e.requestId,status:499};if(a<J){let d=this.backoffDelay(a);return await ee(d),i(a+1,c)}return p.error(`Error fetching ${e.url}: ${String(f)}`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:500,error:f instanceof Error?f.message:"Unknown error"}}};return i(0,s)}catch(t){return p.error(`Error fetching ${e.url}: ${t}`),{type:"fetch-response",responseType:"error",requestId:e.requestId,status:500,error:t instanceof Error?t.message:"Unknown error"}}finally{this.abortSignals.delete(e.requestId)}}async stream(e,t){let o=new AbortController;this.streamControllers.set(e.requestId,o);let s=Me(e.url),r=await this.authProvider.getToken(),i=this.shouldAttachAuth(s),a=async(c,u)=>{let h=this.buildHeaders(e.headers,u,{method:e.method,attachAuth:i}),f=Object.keys(h).some(d=>d.toLowerCase()==="authorization");try{let d=await fetch(s,{method:e.method,headers:h,body:e.body,signal:o.signal});if(d.status===200&&d.body!=null){for await(let m of ut(d.body,o.signal))t({type:"fetch-stream-event",requestId:e.requestId,event:m.event,data:m.data});t({type:"fetch-stream-complete",requestId:e.requestId});return}if(d.status===401&&f&&c<J){let m=await this.authProvider.getToken(!0);if(m&&m!==u){await a(c+1,m);return}}if(this.shouldRetryStatus(d.status)&&c<J){let m=this.backoffDelay(c);await ee(m),await a(c+1,u);return}t({type:"fetch-stream-error",requestId:e.requestId,error:`${d.status} ${d.statusText}`})}catch(d){if(o.signal.aborted||mt(d)){t({type:"fetch-stream-complete",requestId:e.requestId});return}if(c<J){let m=this.backoffDelay(c);await ee(m),await a(c+1,u);return}t({type:"fetch-stream-error",requestId:e.requestId,error:d instanceof Error?d.message:"Unknown error"})}};try{await a(0,r)}finally{this.streamControllers.delete(e.requestId)}}cancel(e){let t=this.abortSignals.get(e);t&&(t.abort(),this.abortSignals.delete(e))}cancelStream(e){let t=this.streamControllers.get(e);t&&(t.abort(),this.streamControllers.delete(e))}};function Jo(n){return n?/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+$/.test(n):!1}var M=g(require("vscode"));function Ko(n){return n.path.split("/").pop()??""}function De(){return M.window.tabGroups.all.flatMap(n=>n.tabs.filter(e=>e.input?.uri?.scheme==="file").map(e=>({label:e.label,path:M.workspace.asRelativePath(e.input?.uri?.fsPath),fsPath:e.input?.uri?.fsPath})))}function Oe(n){return{label:Ko(n.document.uri),path:M.workspace.asRelativePath(n.document.uri.fsPath),fsPath:n.document.uri.fsPath,selection:n.selection,activeSelectionContent:n.document.getText(n.selection),selections:n.selections.map(e=>({start:e.start,end:e.end}))}}var he=class{onIdeContextChangeEmitter=new M.EventEmitter;listeners=[];ideContext={activeFile:void 0,openTabs:[]};constructor(){this.listeners.push(M.window.onDidChangeActiveTextEditor(e=>this.onChangeActiveTextEditor(e))),this.listeners.push(M.window.onDidChangeTextEditorSelection(e=>{this.onChangeTextEditorSelection(e)})),this.initIdeContext()}get onIdeContextChange(){return this.onIdeContextChangeEmitter.event}getIdeContext(){return this.ideContext}initIdeContext(){let e=M.window.activeTextEditor;this.ideContext={activeFile:e?Oe(e):void 0,openTabs:De()},this.onIdeContextChangeEmitter.fire(this.ideContext)}onChangeActiveTextEditor(e){this.ideContext={...this.ideContext,activeFile:e?Oe(e):void 0,openTabs:De()},this.onIdeContextChangeEmitter.fire(this.ideContext)}onChangeTextEditorSelection(e){e.textEditor.document.uri.scheme==="file"&&(this.ideContext={...this.ideContext,activeFile:Oe(e.textEditor),openTabs:De()},this.onIdeContextChangeEmitter.fire(this.ideContext))}dispose(){this.listeners.forEach(e=>e.dispose())}};E();var Le=g(require("vscode")),ge=class{shellIntegrationSubscription;pendingTerminals=new Map;constructor(){this.shellIntegrationSubscription=Le.window.onDidChangeTerminalShellIntegration(e=>{let{terminal:t}=e,o=this.pendingTerminals.get(t);o&&(o(t),this.pendingTerminals.delete(t))})}createTerminal(e){let t=Le.window.createTerminal(e);return new Promise(o=>{this.pendingTerminals.set(t,o)})}dispose(){this.shellIntegrationSubscription.dispose()}};function gt(n){let e=[],t=n.length,o=0;function s(a,c){let u=n[a],h=c;for(;h<t&&n[h]===u;)h++;let f=ve(n,h),d=ht(n,f,"TODO",!0),m=f;for(;m<t&&n[m]!==`
`&&n[m]!=="\r";)m++;if(d!==-1){let v=n.slice(d,m);e.push({body:v.trimEnd(),index:a})}return m}let r=null,i=!1;for(;o<t;){let a=n[o];if(r){i?i=!1:a==="\\"?i=!0:a===r&&(r=null),o++;continue}else if(a==='"'||a==="'"||a==="`"){r=a,o++;continue}if(a==="/"&&o+1<t){let c=n[o+1];if(c==="/"){o=s(o,o+2);continue}if(c==="*"){let u=o,h=o+2,f=n.indexOf("*/",h),d=f===-1?t:f+2,m=n.slice(h,f===-1?t:f);m=m.replace(/^(?:[ \t]*\*?[ \t]*(?:\r?\n|$))+/,"");let v=ve(m,0);m[v]==="*"&&(v=ve(m,v+1));let x=ht(m,v,"TODO",!0);if(x!==-1){let q=m.slice(x);e.push({body:q.replace(/\s+$/,""),index:u})}o=d;continue}}else if(a==="#"){o=s(o,o+1);continue}else if(a==="-"&&o+1<t&&n[o+1]==="-"){o=s(o,o+2);continue}o++}return e}function Qo(n){return n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||n===95}function ve(n,e){let t=e;for(;t<n.length;){let o=n.charCodeAt(t);if(o!==32&&o!==9)break;t++}return t}function ht(n,e,t,o=!0){let s=n.slice(e,e+t.length),r=o?t.toUpperCase():t;if((o?s.toUpperCase():s)!==r)return-1;let i=n.charCodeAt(e+t.length);if(Qo(i))return-1;let a=e+t.length;return(n[a]===":"||n[a]==="-")&&a++,a=ve(n,a),a}var we=g(require("vscode")),ye=class{provideCodeLenses(e,t){let o=e.getText(),s=[];for(let{index:r,body:i}of gt(o)){if(t?.isCancellationRequested)break;let a=e.positionAt(r),c=new we.Range(a,a);s.push(new we.CodeLens(c,{title:"Implement with Codex",command:"chatgpt.implementTodo",arguments:[{fileName:encodeURIComponent(e.uri.fsPath),line:a.line+1,comment:i}]}))}return s}};E();var be=class{constructor(e){this.codexWebviewProvider=e}async handleUri(e){p.info({event:"handleUri",path:e.path});try{await A();let t=e.path||"/";this.codexWebviewProvider.navigateToRoute(t)}catch(t){p.error(`Failed to handle URI ${e.toString()}: ${t instanceof Error?t.message:String(t)}`)}}};var D=g(require("vscode"));async function cn(n){let{subscriptions:e}=n;e.push(p),p.info("Activating Codex extension");let t=new ge;e.push(t);let o=await st(n.extensionUri);e.push(o);let s=tt(o),r=new he;e.push(r);let i=new me(s,r),a=new fe(s,i),c=new $(n.extensionUri,o,a,r);e.push(c);let u=new be(c);if(e.push(D.window.registerUriHandler(u)),e.push(D.window.registerWebviewViewProvider($.viewType,c,{webviewOptions:{retainContextWhenHidden:!0}})),e.push(D.commands.registerCommand("chatgpt.openSidebar",A)),e.push(D.commands.registerCommand("chatgpt.addToChat",async()=>Ye(c))),e.push(D.commands.registerCommand("chatgpt.newChat",async()=>{await A(),c.triggerNewChatViaWebview()})),S().get(U.COMMENT_CODELENS_ENABLED,!0)){let d=new ye,m=[{scheme:"file"},{scheme:"untitled"}];e.push(D.languages.registerCodeLensProvider(m,d))}S().get(U.OPEN_ON_STARTUP,!1)&&A(),process.platform==="darwin"&&(async()=>{try{let d=await Promise.resolve().then(()=>(ao(),io));typeof d.activate=="function"&&(d.activate(n),p.info("Work with apps desktop bridge initialized"))}catch(d){p.warn("Desktop bridge init failed: "+(d instanceof Error?d.message:String(d)))}})()}0&&(module.exports={activate});
